# name: test/sql/aggregate/distinct/test_distinct_with_unnest.test
# description: Test DISTINCT combined with UNNEST(struct) - issue #17278
# group: [distinct]

statement ok
PRAGMA enable_verification

statement ok
CREATE TABLE structs(a STRUCT(m1 INT, m2 INT));

statement ok
INSERT INTO structs VALUES ({'m1': 0, 'm2': 0}), ({'m1': 0, 'm2': 1});

# DISTINCT + UNNEST(struct) from a table must not drop rows
query II rowsort
SELECT DISTINCT UNNEST(a) FROM structs
----
0	0
0	1

# DISTINCT + UNNEST(struct) from an inline union must not drop rows
query TT rowsort
SELECT DISTINCT unnest(a) FROM (
    SELECT {'a': '0', 'b': '0'} AS a
    UNION ALL
    SELECT {'a': '0', 'b': '1'}
)
----
0	0
0	1

# DISTINCT correctly deduplicates when all expanded fields are equal
query II rowsort
SELECT DISTINCT UNNEST(a) FROM (
    SELECT {'m1': 1, 'm2': 2} AS a
    UNION ALL
    SELECT {'m1': 1, 'm2': 2}
)
----
1	2

# DISTINCT ON (positional) with UNNEST(struct) still works correctly:
# DISTINCT ON (1) deduplicates on the first expanded column only
query II rowsort
SELECT DISTINCT ON (1) UNNEST(a) FROM structs ORDER BY 1, 2
----
0	0

# DISTINCT ON using the expanded struct field name (post-UNNEST column name).
# DISTINCT ON (m1) deduplicates on m1 only, so only one row is returned.
query II rowsort
SELECT DISTINCT ON (m1) UNNEST(a) FROM structs ORDER BY 1, 2
----
0	0
