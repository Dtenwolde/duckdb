Statements <- (SingleStatement (';' SingleStatement )* ';'*)

SingleStatement <- SelectStatement / TransactionStatement / CreateStatement / InsertStatement / PragmaStatement
PragmaStatement <- 'PRAGMA'i Identifier (Parens(List(Expression)))?
SelectStatement <- SimpleSelect (SetopClause SimpleSelect)*
TransactionStatement <- TransactionType
CreateStatement <- 'CREATE'i 'TABLE'i Identifier Parens(List(ColumnDefinition))
InsertStatement <- 'INSERT'i 'INTO'i Identifier (ColumnList)? (ValuesList / SelectStatement)
ColumnList <- Parens(List(Identifier))
ValuesList <- 'VALUES'i Value (',' Value)*
Value <- Parens(List(Expression))
ColumnDefinition <- Identifier TypeSpecifier
TransactionType <- 'BEGIN'i 'TRANSACTION'i / 'COMMIT'i / 'ROLLBACK'i
SetopClause <- ('UNION'i / 'EXCEPT'i / 'INTERSECT'i) 'ALL'i?

SimpleSelect <- WithClause? SelectClause FromClause? WhereClause? GroupByClause? HavingClause? OrderByClause? LimitClause?

WithStatement <- Identifier 'AS'i SubqueryReference
WithClause <- 'WITH'i List(WithStatement)
SelectClause <- 'SELECT'i ('*' / List(AliasedExpression))
ColumnAliases <- Parens(List(Identifier))

TableReference <-
    (FunctionExpression ('AS'i Identifier)?) /
    (SubqueryReference 'AS'i? Identifier ColumnAliases?) /
    (Identifier ('AS'i? Identifier)?) /


ExplicitJoin <- ('LEFT'i / 'FULL'i)? 'OUTER'i? 'JOIN'i TableReference 'ON'i Expression

FromClause <- 'FROM'i TableReference ((',' TableReference) / ExplicitJoin)*
WhereClause <- 'WHERE'i Expression
GroupByClause <- 'GROUP'i 'BY'i List(Expression)
HavingClause <- 'HAVING'i Expression

SubqueryReference <- Parens(SelectStatement)

OrderByExpression <- Expression ('DESC'i / 'ASC'i)?  ('NULLS'i 'FIRST'i / 'LAST'i)?
OrderByClause <- 'ORDER'i 'BY'i List(OrderByExpression)

LimitClause <- 'LIMIT'i NumberLiteral

PlainIdentifier <-  !ReservedKeyword <[a-z_]i[a-z0-9_]i*>  # unqoted identifier can't be top-level keyword
QuotedIdentifier <- '"' [^"]* '"'
Identifier <- QuotedIdentifier / PlainIdentifier
NumberLiteral <- < [+-]?[0-9]+([.][0-9]*)? >
StringLiteral <- '\'' [^\']* '\''
TypeSpecifier <- Identifier (Parens(List(NumberLiteral)))?

ColumnReference <- (Identifier '.')?Identifier
FunctionExpression <- Identifier Parens((List(Expression)?))
ParenthesisExpression <- Parens(Expression)
LiteralExpression <- StringLiteral / NumberLiteral
CastExpression <- 'CAST'i Parens(Expression 'AS'i TypeSpecifier)
ExtractExpression <- 'EXTRACT'i Parens(ColumnReference 'FROM'i Expression)
CountStarExpression <- 'COUNT'i Parens('*')
SubqueryExpression <- NotModifier? 'EXISTS'i? SubqueryReference
WhenThen <- 'WHEN'i Expression 'THEN'i Expression
CaseExpression <- 'CASE'i Expression? (WhenThen)+ ('ELSE'i Expression)? 'END'i # TODO strict
DateExpression <- 'DATE'i Expression
DistinctExpression <- 'DISTINCT'i Expression
SubstringExpression <- 'SUBSTRING'i Parens(Expression 'FROM'i NumberLiteral 'FOR'i NumberLiteral)
LiteralListExpression <- Parens(List(Expression))
FrameClause <- 'ROWS'i 'BETWEEN'i (('UNBOUNDED'i 'PRECEDING'i)) 'AND' (('CURRENT'i 'ROW'i))
WindowExpression <- Parens(('PARTITION'i 'BY'i List(Expression))? OrderByClause? FrameClause?)
IsNullExpression <- ColumnReference 'IS'i NotModifier? 'NULL'i
NullExpression <- 'NULL'i
TrueFalseExpression <- 'TRUE'i / 'FALSE'i

SingleExpression <-
    SubqueryExpression /
    LiteralListExpression /
    ParenthesisExpression /
    DateExpression /
    DistinctExpression /
    SubstringExpression /
    IsNullExpression /
    CaseExpression /
    CountStarExpression /
    CastExpression /
    ExtractExpression /
    WindowExpression /
    FunctionExpression /
    ColumnReference /
    LiteralExpression /
    NullExpression /
    TrueFalseExpression

ArithmeticOperator <- '+' / '-' / '*' / '/'
NotModifier <- 'NOT'i
LikeOperator <- NotModifier? ('LIKE'i / 'ILIKE'i)
InOperator <- NotModifier? 'IN'i
BooleanOperator <- 'OR'i / 'AND'i
ComparisonOperator <-  '=' / '<=' / '>=' / '<' / '>'
WindowOperator <- 'OVER'i
BetweenOperator <- 'BETWEEN'i

Operator <-
    ArithmeticOperator /
    ComparisonOperator /
    BooleanOperator /
    LikeOperator /
    InOperator /
    WindowOperator /
    BetweenOperator

Expression <- NotModifier? SingleExpression (Operator SingleExpression)*
AliasedExpression <- Expression ('AS'i? Identifier)?

# internal definitions
%whitespace <- [ \t\n\r]*
%word <- [a-zA-Z_-]
List(D) <- D (',' D)*
Parens(D) <- '(' D ')'